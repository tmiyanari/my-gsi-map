<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <title>ãƒã‚¤ãƒãƒƒãƒ— - å®Œæˆç‰ˆ</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.css" />
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #ui { position: absolute; top: 10px; left: 10px; z-index: 10; display: flex; flex-direction: column; gap: 8px; width: 200px; }
        .group { background: rgba(255,255,255,0.9); padding: 8px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 5px; }
        button { padding: 10px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; font-weight: bold; background: white; }
        .layer-btns { display: flex; gap: 2px; }
        .layer-btns button { flex: 1; padding: 5px; font-size: 11px; }
        #status { font-size: 11px; color: #555; text-align: center; }
    </style>
</head>
<body>

<div id="ui">
    <div class="group">
        <div class="layer-btns">
            <button id="btn-std">æ¨™æº–</button>
            <button id="btn-pale">æ·¡è‰²</button>
            <button id="btn-ort">å†™çœŸ</button>
        </div>
    </div>
    <div class="group">
        <button id="btn-add" style="background:#007bff; color:white; border:none;">ğŸ“ åœ°ç‚¹è¿½åŠ : OFF</button>
        <button id="btn-del" style="background:#dc3545; color:white; border:none;">ğŸ—‘ï¸ é¸æŠå‰Šé™¤</button>
        <button id="btn-save" style="background:#28a745; color:white; border:none;">â˜ï¸ GitHubä¿å­˜</button>
        <div id="status">æº–å‚™ä¸­...</div>
    </div>
</div>
<div id="map"></div>

<script>
    // --- 1. è¨­å®š ---
    const GITHUB_TOKEN = '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'; 
    const REPO_PATH = 'tmiyanari/my-gsi-map';
    const FILE_PATH = 'mydata.geojson';

    // --- 2. åœ°å›³åˆæœŸåŒ– ---
    const map = new maplibregl.Map({
        container: 'map',
        style: {
            version: 8,
            glyphs: "https://fonts.openmaptiles.org/{fontstack}/{range}.pbf",
            sources: { 'gsi': { type: 'raster', tiles: ['https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png'], tileSize: 256, attribution: "åœ°ç†é™¢åœ°å›³" } },
            layers: [{ id: 'gsi-layer', type: 'raster', source: 'gsi' }]
        },
        center: [139.767, 35.681],
        zoom: 12
    });

    // --- 3. æç”»ãƒ„ãƒ¼ãƒ« (åå‰è¡¨ç¤ºä»˜ã) ---
    const draw = new MapboxDraw({
        displayControlsDefault: false,
        styles: [
            { 'id': 'pts-off', 'type': 'circle', 'filter': ['all', ['==', '$type', 'Point'], ['==', 'meta', 'feature'], ['==', 'active', 'false']], 'paint': { 'circle-radius': 8, 'circle-color': '#ff4500', 'circle-stroke-width': 2, 'circle-stroke-color': '#fff' } },
            { 'id': 'pts-on', 'type': 'circle', 'filter': ['all', ['==', '$type', 'Point'], ['==', 'meta', 'feature'], ['==', 'active', 'true']], 'paint': { 'circle-radius': 10, 'circle-color': '#ffff00', 'circle-stroke-width': 2, 'circle-stroke-color': '#000' } },
            { 'id': 'lbls', 'type': 'symbol', 'filter': ['all', ['==', '$type', 'Point'], ['==', 'meta', 'feature']], 
              'layout': { 'text-field': '{name}', 'text-font': ['Open Sans Regular'], 'text-size': 14, 'text-offset': [0, 1.3], 'text-anchor': 'top' },
              'paint': { 'text-color': '#000', 'text-halo-color': '#fff', 'text-halo-width': 2 }
            }
        ]
    });
    map.addControl(draw);

    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–¢æ•°
    const loadToMap = (data) => {
        if (!data || !data.features) return;
        draw.deleteAll();
        data.features.forEach(f => {
            const id = draw.add(f)[0];
            draw.setFeatureProperty(id, 'name', f.properties.name || "ç„¡é¡Œ");
        });
    };

    // --- 4. èµ·å‹•æ™‚å‡¦ç† (ãƒ©ã‚°å¯¾ç­–ãƒ»å·»ãæˆ»ã‚Šé˜²æ­¢) ---
    map.on('load', async () => {
        const log = document.getElementById('status');
        const local = localStorage.getItem('map_backup');
        let localData = local ? JSON.parse(local) : null;
        
        if (localData) {
            loadToMap(localData);
            log.innerText = "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾©å…ƒæ¸ˆã¿";
        }

        try {
            const res = await fetch(`https://raw.githubusercontent.com/${REPO_PATH}/main/${FILE_PATH}?t=${Date.now()}`);
            if (res.ok) {
                const gitData = await res.json();
                const localTime = localData?.last_updated || 0;
                const gitTime = gitData.last_updated || 0;

                if (gitTime >= localTime) {
                    loadToMap(gitData);
                    localStorage.setItem('map_backup', JSON.stringify(gitData));
                    log.innerText = "æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸ";
                } else {
                    log.innerText = "GitHubåæ˜ å¾…ã¡(ãƒ­ãƒ¼ã‚«ãƒ«å„ªå…ˆ)";
                }
            }
        } catch (e) { log.innerText = "ã‚ªãƒ•ãƒ©ã‚¤ãƒ³"; }
    });

    // --- 5. åœ°å›³è¿½åŠ ãƒ»ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— ---
    let addMode = false;
    document.getElementById('btn-add').onclick = () => {
        addMode = !addMode;
        const btn = document.getElementById('btn-add');
        btn.innerText = addMode ? "ğŸ“ åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯" : "ğŸ“ åœ°ç‚¹è¿½åŠ : OFF";
        btn.style.background = addMode ? "#ff4500" : "#007bff";
    };

    map.on('click', (e) => {
        if (addMode) {
            const name = prompt("å ´æ‰€ã®åå‰:");
            if (!name) return;
            const id = draw.add({ type: 'Feature', properties: { name: name }, geometry: { type: 'Point', coordinates: [e.lngLat.lng, e.lngLat.lat] } })[0];
            draw.setFeatureProperty(id, 'name', name);
        } else {
            const fs = map.queryRenderedFeatures(e.point).filter(f => f.properties.name);
            if (fs.length) {
                new maplibregl.Popup().setLngLat(e.lngLat).setHTML(`<b>${fs[0].properties.name}</b>`).addTo(map);
            }
        }
    });

    document.getElementById('btn-del').onclick = () => {
        const ids = draw.getSelectedIds();
        if (ids.length && confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) draw.delete(ids);
    };

    // --- 6. ä¿å­˜ (å·»ãæˆ»ã‚Šé˜²æ­¢ã‚¹ã‚¿ãƒ³ãƒ—) ---
    document.getElementById('btn-save').onclick = async () => {
        const btn = document.getElementById('btn-save');
        btn.innerText = "ä¿å­˜ä¸­...";
        const data = draw.getAll();
        data.last_updated = Date.now(); // ã“ã“ã§æ™‚é–“ã‚’åˆ»å°ï¼
        const content = JSON.stringify(data);

        try {
            const res = await fetch(`https://api.github.com/repos/${REPO_PATH}/contents/${FILE_PATH}`, { headers: { 'Authorization': `token ${GITHUB_TOKEN}` } });
            const info = await res.json();
            const put = await fetch(`https://api.github.com/repos/${REPO_PATH}/contents/${FILE_PATH}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${GITHUB_TOKEN}` },
                body: JSON.stringify({ message: "update", content: btoa(unescape(encodeURIComponent(content))), sha: info.sha })
            });
            if (put.ok) {
                localStorage.setItem('map_backup', content);
                alert("ä¿å­˜å®Œäº†ï¼ã‚‚ã†å·»ãæˆ»ã‚Šã¾ã›ã‚“ã€‚");
            }
        } catch (e) { alert("ä¿å­˜å¤±æ•—"); }
        btn.innerText = "â˜ï¸ GitHubä¿å­˜";
    };

    // --- 7. åœ°å›³åˆ‡ã‚Šæ›¿ãˆå†å®Ÿè£… ---
    const switchLayer = (t) => {
        const urls = { 'std': 'std/{z}/{x}/{y}.png', 'pale': 'pale/{z}/{x}/{y}.png', 'ort': 'ort/{z}/{x}/{y}.jpg' };
        map.removeLayer('gsi-layer');
        map.removeSource('gsi');
        map.addSource('gsi', { type: 'raster', tiles: [`https://cyberjapandata.gsi.go.jp/xyz/${urls[t]}`], tileSize: 256, attribution: "åœ°ç†é™¢åœ°å›³" });
        map.addLayer({ id: 'gsi-layer', type: 'raster', source: 'gsi' }, map.getStyle().layers[0].id);
    };
    document.getElementById('btn-std').onclick = () => switchLayer('std');
    document.getElementById('btn-pale').onclick = () => switchLayer('pale');
    document.getElementById('btn-ort').onclick = () => switchLayer('ort');

</script>
</body>
</html>
