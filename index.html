<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <title>ãƒã‚¤ç·¨é›†GIS - ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸç‰ˆ</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.css" />
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #ui-panel { position: absolute; top: 10px; left: 10px; z-index: 100; display: flex; flex-direction: column; gap: 8px; width: 200px; }
        button { padding: 10px; cursor: pointer; background: white; border: 1px solid #ccc; border-radius: 4px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        button:hover { background: #f0f0f0; }
        #console-log { background: rgba(255, 255, 255, 0.9); padding: 10px; border: 1px solid #ccc; font-size: 12px; pointer-events: none; border-radius: 4px; }
        .layer-btns { display: flex; gap: 2px; }
        .layer-btns button { flex: 1; padding: 5px; font-size: 11px; }
    </style>
</head>
<body>

<div id="ui-panel">
    <div class="layer-btns">
        <button id="btn-layer-std">æ¨™æº–</button>
        <button id="btn-layer-pale">æ·¡è‰²</button>
        <button id="btn-layer-ort">å†™çœŸ</button>
    </div>
    <button id="btn-add-point" style="background: #007bff; color: white; border: none;">ğŸ“ åœ°ç‚¹è¿½åŠ : OFF</button>
    <button id="btn-delete" style="background: #dc3545; color: white; border: none;">ğŸ—‘ï¸ é¸æŠã‚’å‰Šé™¤</button>
    <button id="btn-save" style="background: #28a745; color: white; border: none;">â˜ï¸ GitHubã¸ä¿å­˜</button>
    <div id="console-log">åœ°å›³ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...</div>
</div>

<div id="map"></div>

<script>
    // --- è¨­å®šé …ç›® ---
    const GITHUB_TOKEN = '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'; 
    const REPO_PATH = 'tmiyanari/my-gsi-map';
    const FILE_PATH = 'mydata.geojson';

    // 1. åœ°å›³ã®åˆæœŸåŒ–
    const map = new maplibregl.Map({
        container: 'map',
        style: {
            version: 8,
            glyphs: "https://fonts.openmaptiles.org/{fontstack}/{range}.pbf",
            sources: {
                'gsi-tiles': {
                    type: 'raster',
                    tiles: ['https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png'],
                    tileSize: 256,
                    attribution: "åœ°ç†é™¢åœ°å›³"
                }
            },
            layers: [{ id: 'gsi-layer', type: 'raster', source: 'gsi-tiles' }]
        },
        center: [139.767, 35.681],
        zoom: 12
    });

    // 2. æç”»ãƒ„ãƒ¼ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆåå‰è¡¨ç¤ºæ©Ÿèƒ½ä»˜ãï¼‰
    const draw = new MapboxDraw({
        displayControlsDefault: false,
        styles: [
            // é€šå¸¸ã®ç‚¹
            {
                'id': 'gl-draw-point-static',
                'type': 'circle',
                'filter': ['all', ['==', '$type', 'Point'], ['==', 'meta', 'feature'], ['==', 'active', 'false']],
                'paint': { 'circle-radius': 8, 'circle-color': '#ff4500', 'circle-stroke-width': 2, 'circle-stroke-color': '#fff' }
            },
            // é¸æŠä¸­ã®ç‚¹
            {
                'id': 'gl-draw-point-active',
                'type': 'circle',
                'filter': ['all', ['==', '$type', 'Point'], ['==', 'meta', 'feature'], ['==', 'active', 'true']],
                'paint': { 'circle-radius': 10, 'circle-color': '#ffff00', 'circle-stroke-width': 2, 'circle-stroke-color': '#000' }
            },
            // â˜…åå‰ãƒ©ãƒ™ãƒ«è¡¨ç¤º
            {
                'id': 'points-labels',
                'type': 'symbol',
                'filter': ['all', ['==', '$type', 'Point'], ['==', 'meta', 'feature']],
                'layout': {
                    'text-field': ['get', 'name'],
                    'text-font': ['Open Sans Regular'],
                    'text-size': 14,
                    'text-anchor': 'top',
                    'text-offset': [0, 1.3]
                },
                'paint': {
                    'text-color': '#000',
                    'text-halo-color': '#fff',
                    'text-halo-width': 2
                }
            },
            // ãƒ‰ãƒ©ãƒƒã‚°ç”¨ã®ç‚¹
            {
                'id': 'gl-draw-point-stroke-active',
                'type': 'circle',
                'filter': ['all', ['==', '$type', 'Point'], ['==', 'meta', 'vertex']],
                'paint': { 'circle-radius': 10, 'circle-color': '#f00' }
            }
        ]
    });
    map.addControl(draw);

    // 3. ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— & æ–°æ—§æ¯”è¼ƒæ©Ÿèƒ½ï¼‰
    map.on('load', async () => {
        const logDiv = document.getElementById('console-log');
        
        // A. ã¾ãšãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤ºï¼ˆçˆ†é€Ÿè¡¨ç¤ºï¼‰
        const localDataRaw = localStorage.getItem('map_data_backup');
        let localData = localDataRaw ? JSON.parse(localDataRaw) : null;
        if (localData) {
            loadToDraw(localData);
            logDiv.innerText = "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å¾©å…ƒ";
        }

        // B. GitHubã‹ã‚‰æœ€æ–°ã‚’å–å¾—ã—ã¦æ¯”è¼ƒ
        try {
            const url = `https://raw.githubusercontent.com/${REPO_PATH}/main/${FILE_PATH}?t=${new Date().getTime()}`;
            const res = await fetch(url, { cache: 'no-store' });
            if (res.ok) {
                const githubData = await res.json();
                const localTime = localData?.last_updated || 0;
                const githubTime = githubData.last_updated || 0;

                if (githubTime >= localTime) {
                    loadToDraw(githubData);
                    localStorage.setItem('map_data_backup', JSON.stringify(githubData));
                    logDiv.innerText = "GitHubã¨åŒæœŸå®Œäº†";
                } else {
                    logDiv.innerText = "GitHubåæ˜ å¾…ã¡...ãƒ­ãƒ¼ã‚«ãƒ«å„ªå…ˆ";
                }
            }
        } catch (err) {
            logDiv.innerText = "ã‚ªãƒ•ãƒ©ã‚¤ãƒ³è¡¨ç¤ºä¸­";
        }
    });

    // Drawã«ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å£Šã•ãšèª­ã¿è¾¼ã‚€é–¢æ•°
    function loadToDraw(data) {
        if (!data.features) return;
        draw.deleteAll();
        const features = data.features.map(f => ({
            id: f.id || `id_${Math.random().toString(36).substr(2, 9)}`,
            type: 'Feature',
            properties: { 
                name: f.properties.name || "", 
                time: f.properties.time || "" 
            },
            geometry: f.geometry
        }));
        draw.add({ type: 'FeatureCollection', features: features });
    }

    // 4. åœ°ç‚¹è¿½åŠ ãƒ­ã‚¸ãƒƒã‚¯
    let isAddMode = false;
    const addBtn = document.getElementById('btn-add-point');
    addBtn.onclick = () => {
        isAddMode = !isAddMode;
        addBtn.style.background = isAddMode ? '#ff4500' : '#007bff';
        addBtn.innerText = isAddMode ? 'ğŸ“ åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯' : 'ğŸ“ åœ°ç‚¹è¿½åŠ : OFF';
    };

    map.on('click', (e) => {
        if (!isAddMode) return;
        const name = prompt("å ´æ‰€ã®åå‰:", "æ–°è¦åœ°ç‚¹");
        if (!name) return;
        draw.add({
            type: 'Feature',
            properties: { name: name, time: new Date().toLocaleString() },
            geometry: { type: 'Point', coordinates: [e.lngLat.lng, e.lngLat.lat] }
        });
        document.getElementById('console-log').innerText = `ã€Œ${name}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ`;
    });

    // 5. å‰Šé™¤ãƒ­ã‚¸ãƒƒã‚¯
    document.getElementById('btn-delete').onclick = () => {
        const selected = draw.getSelected();
        if (selected.features.length === 0) return alert("å‰Šé™¤ã™ã‚‹ç‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„");
        if (confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            draw.delete(selected.features.map(f => f.id));
            alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚ä¿å­˜ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ç¢ºå®šã—ã¾ã™ã€‚");
        }
    };

    // 6. ä¿å­˜ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæ—¥æ™‚ã®åˆ»å°ä»˜ãï¼‰
    document.getElementById('btn-save').onclick = async () => {
        const btn = document.getElementById('btn-save');
        btn.innerText = "ä¿å­˜ä¸­...";
        btn.disabled = true;

        const data = draw.getAll();
        data.last_updated = new Date().getTime(); // é®®åº¦ã‚¹ã‚¿ãƒ³ãƒ—
        const content = JSON.stringify(data, null, 2);

        try {
            const res = await fetch(`https://api.github.com/repos/${REPO_PATH}/contents/${FILE_PATH}`, {
                headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
            });
            const fileData = await res.json();
            const updateRes = await fetch(`https://api.github.com/repos/${REPO_PATH}/contents/${FILE_PATH}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: "Map Update",
                    content: btoa(unescape(encodeURIComponent(content))),
                    sha: fileData.sha
                })
            });

            if (updateRes.ok) {
                localStorage.setItem('map_data_backup', content);
                alert("ä¿å­˜æˆåŠŸï¼åæ˜ ã¾ã§ç´„1åˆ†ã‹ã‹ã‚Šã¾ã™ãŒã€ã“ã®ç”»é¢ã§ã¯å³æ™‚åæ˜ ã•ã‚Œã¦ã„ã¾ã™ã€‚");
            }
        } catch (err) { alert("ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + err.message); }
        btn.innerText = "â˜ï¸ GitHubã¸ä¿å­˜";
        btn.disabled = false;
    };

    // 7. ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ‡ã‚Šæ›¿ãˆ
    const switchLayer = (type) => {
        const tiles = {
            'std': 'https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png',
            'pale': 'https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png',
            'ort': 'https://cyberjapandata.gsi.go.jp/xyz/ort/{z}/{x}/{y}.jpg'
        };
        map.removeLayer('gsi-layer');
        map.removeSource('gsi-tiles');
        map.addSource('gsi-tiles', { type: 'raster', tiles: [tiles[type]], tileSize: 256, attribution: "åœ°ç†é™¢åœ°å›³" });
        map.addLayer({ id: 'gsi-layer', type: 'raster', source: 'gsi-tiles' }, map.getStyle().layers[0].id);
    };
    document.getElementById('btn-layer-std').onclick = () => switchLayer('std');
    document.getElementById('btn-layer-pale').onclick = () => switchLayer('pale');
    document.getElementById('btn-layer-ort').onclick = () => switchLayer('ort');

</script>
</body>
</html>
