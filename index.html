<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <title>編集できる地理院地図</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.css" />
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #console-log { position: absolute; bottom: 30px; left: 10px; background: white; padding: 10px; max-width: 300px; max-height: 100px; overflow: auto; border: 2px solid #FF4500; z-index: 10; }
/* 描画中のポインタを強制的に有効にする */
.mapboxgl-canvas-container.mapboxgl-interactive,
.maplibregl-canvas-container.maplibregl-interactive {
    cursor: crosshair !important;
}

/* 描画コントロールが他の要素に隠れないようにする */
.mapboxgl-ctrl-group, .maplibregl-ctrl-group {
    z-index: 100 !important;
}        
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="console-log">ここに座標が出ます</div>

    <script>
        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: {
                    'gsi-tiles': {
                        type: 'raster',
                        tiles: ['https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: "地理院地図"
                    }
                },
                layers: [{ id: 'gsi-layer', type: 'raster', source: 'gsi-tiles' }]
            },
            center: [139.767, 35.681],
            zoom: 12
        });

        // 1. 描画ツールの初期化（少し設定を厳しめに）
const draw = new MapboxDraw({
    displayControlsDefault: false,
    controls: {
        point: true,
        trash: true
    },
    // これを追加：描画中に地図を動かしても描画を継続
    touchEnabled: false 
});
map.addControl(draw, 'top-left');

// 2. 【重要】地図クリック時の伝播を確認
map.on('click', (e) => {
    // コンソールに座標が出るか確認
    console.log("地図がクリックされました:", e.lngLat);
    
    // 描画モードが「点を打つモード」なら、強制的に点を追加する処理（デバッグ用）
    const mode = draw.getMode();
    if (mode === 'draw_point') {
        console.log("現在、点打ちモードです");
    }
});

        // 地図上にログを表示する関数
        function updateDisplay() {
            const data = draw.getAll();
            const logDiv = document.getElementById('console-log');
            if (data.features.length > 0) {
                logDiv.innerText = JSON.stringify(data.features[data.features.length - 1].geometry.coordinates);
                console.log("全データ:", JSON.stringify(data));
            }
        }

        // イベント登録（作成・更新・削除時に発火）
        map.on('draw.create', updateDisplay);
        map.on('draw.update', updateDisplay);
        map.on('draw.delete', updateDisplay);
    </script>
</body>
</html>
