<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <title>åå‰ç·¨é›†ãƒã‚¤ãƒãƒƒãƒ—</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.css" />
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #ui { position: absolute; top: 10px; left: 10px; z-index: 10; display: flex; flex-direction: column; gap: 8px; width: 210px; }
        .group { background: rgba(255,255,255,0.95); padding: 10px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; flex-direction: column; gap: 8px; }
        button { padding: 10px; cursor: pointer; border: 1px solid #ddd; border-radius: 5px; font-weight: bold; background: white; transition: 0.2s; }
        button:hover { background: #f8f8f8; }
        .layer-btns { display: flex; gap: 4px; }
        .layer-btns button { flex: 1; padding: 6px; font-size: 11px; }
        #status { font-size: 12px; color: #444; text-align: center; border-top: 1px solid #eee; pt: 5px; }
    </style>
</head>
<body>

<div id="ui">
    <div class="group">
        <div class="layer-btns">
            <button id="btn-std">æ¨™æº–</button>
            <button id="btn-pale">æ·¡è‰²</button>
            <button id="btn-ort">å†™çœŸ</button>
        </div>
    </div>
    <div class="group">
        <button id="btn-add" style="background:#007bff; color:white; border:none;">ğŸ“ åœ°ç‚¹è¿½åŠ : OFF</button>
        <button id="btn-del" style="background:#dc3545; color:white; border:none;">ğŸ—‘ï¸ é¸æŠå‰Šé™¤</button>
        <button id="btn-save" style="background:#28a745; color:white; border:none;">â˜ï¸ GitHubä¿å­˜</button>
        <div id="status">ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ä¸­...</div>
    </div>
</div>
<div id="map"></div>

<script>
    const GITHUB_TOKEN = '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'; 
    const REPO_PATH = 'tmiyanari/my-gsi-map';
    const FILE_PATH = 'mydata.geojson';

    const map = new maplibregl.Map({
        container: 'map',
        style: {
            version: 8,
            glyphs: "https://fonts.openmaptiles.org/{fontstack}/{range}.pbf",
            sources: { 
                'gsi': { type: 'raster', tiles: ['https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png'], tileSize: 256, attribution: "åœ°ç†é™¢åœ°å›³" },
                'labels-src': { type: 'geojson', data: { type: 'FeatureCollection', features: [] } } // ãƒ©ãƒ™ãƒ«å°‚ç”¨ã‚½ãƒ¼ã‚¹
            },
            layers: [
                { id: 'gsi-layer', type: 'raster', source: 'gsi' },
                { 
                    id: 'labels-layer', 
                    type: 'symbol', 
                    source: 'labels-src',
                    layout: { 
                        'text-field': ['get', 'name'], 
                        'text-font': ['Open Sans Regular'], 
                        'text-size': 14, 
                        'text-offset': [0, 1.5], 
                        'text-anchor': 'top' 
                    },
                    paint: { 'text-color': '#000', 'text-halo-color': '#fff', 'text-halo-width': 2 }
                }
            ]
        },
        center: [139.767, 35.681],
        zoom: 12
    });

    const draw = new MapboxDraw({
        displayControlsDefault: false,
        styles: [
            { 'id': 'pts-off', 'type': 'circle', 'filter': ['all', ['==', '$type', 'Point'], ['==', 'meta', 'feature'], ['==', 'active', 'false']], 'paint': { 'circle-radius': 8, 'circle-color': '#ff4500', 'circle-stroke-width': 2, 'circle-stroke-color': '#fff' } },
            { 'id': 'pts-on', 'type': 'circle', 'filter': ['all', ['==', '$type', 'Point'], ['==', 'meta', 'feature'], ['==', 'active', 'true']], 'paint': { 'circle-radius': 10, 'circle-color': '#ffff00', 'circle-stroke-width': 2, 'circle-stroke-color': '#000' } }
        ]
    });
    map.addControl(draw);

    // ãƒ©ãƒ™ãƒ«è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    const refreshLabels = () => {
        const data = draw.getAll();
        map.getSource('labels-src').setData(data);
    };

    const loadToMap = (data) => {
        if (!data || !data.features) return;
        draw.deleteAll();
        data.features.forEach(f => {
            draw.add(f);
        });
        refreshLabels();
    };

    map.on('load', async () => {
        const log = document.getElementById('status');
        const local = localStorage.getItem('map_backup');
        let localData = local ? JSON.parse(local) : null;
        
        if (localData) {
            loadToMap(localData);
            log.innerText = "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾©å…ƒ";
        }

        try {
            const res = await fetch(`https://raw.githubusercontent.com/${REPO_PATH}/main/${FILE_PATH}?t=${Date.now()}`);
            if (res.ok) {
                const gitData = await res.json();
                const localTime = localData?.last_updated || 0;
                const gitTime = gitData.last_updated || 0;

                if (gitTime >= localTime) {
                    loadToMap(gitData);
                    localStorage.setItem('map_backup', JSON.stringify(gitData));
                    log.innerText = "GitHubæœ€æ–°åŒæœŸ";
                } else {
                    log.innerText = "GitHubåæ˜ å¾…ã¡...";
                }
            }
        } catch (e) { log.innerText = "ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å‹•ä½œä¸­"; }
    });

    // --- åœ°ç‚¹è¿½åŠ ã¨ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— ---
    let addMode = false;
    document.getElementById('btn-add').onclick = () => {
        addMode = !addMode;
        const btn = document.getElementById('btn-add');
        btn.innerText = addMode ? "ğŸ“ åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯" : "ğŸ“ åœ°ç‚¹è¿½åŠ : OFF";
        btn.style.background = addMode ? "#ff4500" : "#007bff";
    };

map.on('click', (e) => {
        if (addMode) {
            const name = prompt("å ´æ‰€ã®åå‰ã‚’å…¥åŠ›:");
            if (!name) return;
            draw.add({ type: 'Feature', properties: { name: name }, geometry: { type: 'Point', coordinates: [e.lngLat.lng, e.lngLat.lat] } });
            refreshLabels();
        } else {
            // ã‚¨ãƒ©ãƒ¼å›é¿ï¼šå­˜åœ¨ã™ã‚‹ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆlabels-layerï¼‰ã ã‘ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
            const features = map.queryRenderedFeatures(e.point, {
                layers: ['labels-layer']
            });

            if (features.length > 0) {
                const target = features[0];
                const currentName = target.properties.name || "åå‰ãªã—";
                
                // Drawå†…ã®IDã‚’å–å¾—ï¼ˆMapLibreã®Feature IDã¾ãŸã¯ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰ï¼‰
                const featureId = target.id || target.properties.id;

                const popupContent = `
                    <div style="padding:10px; min-width:120px;">
                        <b id="popup-name">${currentName}</b><br>
                        <button onclick="editName('${featureId}', ${e.lngLat.lng}, ${e.lngLat.lat})" 
                                style="margin-top:8px; padding:4px 8px; font-size:11px; cursor:pointer;">âœï¸ åå‰ã‚’å¤‰æ›´</button>
                    </div>
                `;

                new maplibregl.Popup({ closeButton: true })
                    .setLngLat(e.lngLat)
                    .setHTML(popupContent)
                    .addTo(map);
            }
        }
    });

    // åå‰ç·¨é›†é–¢æ•°ï¼ˆåº§æ¨™ã‚’ä½¿ã£ã¦ç¢ºå®Ÿã«ç‰¹å®šã™ã‚‹ç‰ˆï¼‰
   // åå‰ç·¨é›†é–¢æ•°ï¼ˆåº§æ¨™ã¨IDã®ãƒ€ãƒ–ãƒ«ãƒã‚§ãƒƒã‚¯ç‰ˆï¼‰
window.editName = (id, lng, lat) => {
    // 1. ã¾ãšã¯IDã§æ¢ã—ã¦ã¿ã‚‹
    let feature = draw.get(id);
    
    // 2. IDã§è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸåº§æ¨™ã®è¿‘ãã«ã‚ã‚‹åœ°ç‚¹ã‚’æ¢ã™
    if (!feature) {
        const allFeatures = draw.getAll().features;
        feature = allFeatures.find(f => {
            const coords = f.geometry.coordinates;
            // åº§æ¨™ãŒéå¸¸ã«è¿‘ã„ï¼ˆèª¤å·® 0.0001åº¦ä»¥å†…ï¼‰ã‚‚ã®ã‚’ç‰¹å®š
            return Math.abs(coords[0] - lng) < 0.0001 && 
                   Math.abs(coords[1] - lat) < 0.0001;
        });
    }

    // â˜… ã“ã“ã§ feature ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã®ã‚¬ãƒ¼ãƒ‰ã‚’å…¥ã‚Œã‚‹ï¼ˆã‚¨ãƒ©ãƒ¼é˜²æ­¢ï¼‰
    if (!feature) {
        alert("åœ°ç‚¹ã‚’ç‰¹å®šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ã‚¯ãƒªãƒƒã‚¯ã—ç›´ã—ã¦ãã ã•ã„ã€‚");
        return;
    }

    // 3. ç·¨é›†å‡¦ç†
    const oldName = feature.properties.name || "";
    const newName = prompt("æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:", oldName);
    
    if (newName !== null && newName !== "") {
        // Drawå´ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ï¼ˆfeature.id ã‚’ä½¿ç”¨ï¼‰
        draw.setFeatureProperty(feature.id, 'name', newName);
        
        // çœ‹æ¿ï¼ˆãƒ©ãƒ™ãƒ«ï¼‰ã‚’æ›´æ–°
        if (typeof refreshLabels === 'function') refreshLabels();
        
        // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å†…ã®è¡¨ç¤ºã‚‚æ›¸ãæ›ãˆ
        const nameEl = document.getElementById('popup-name');
        if (nameEl) nameEl.innerText = newName;
        
        document.getElementById('status').innerText = "åå‰ã‚’æ›´æ–°ã—ã¾ã—ãŸ";
    }
};
        if (!feature) return alert("ç·¨é›†å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");

        const oldName = feature.properties.name || "";
        const newName = prompt("æ–°ã—ã„åå‰ã‚’å…¥åŠ›:", oldName);
        
        if (newName !== null && newName !== "") {
            draw.setFeatureProperty(feature.id, 'name', newName);
            refreshLabels(); // çœ‹æ¿ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æ›´æ–°
            
            const nameEl = document.getElementById('popup-name');
            if (nameEl) nameEl.innerText = newName;
            document.getElementById('status').innerText = "åå‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ";
        }
    };

// --- åå‰ç·¨é›†é–¢æ•° (ã“ã“ã‹ã‚‰) ---
window.editName = function(id, lng, lat) {
    // 1. ã¾ãšã¯IDã§æ¤œç´¢
    let feature = draw.get(id);
    
    // 2. IDã§è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€åº§æ¨™ã®è¿‘ã•ã§æ¤œç´¢
    if (!feature) {
        const allFeatures = draw.getAll().features;
        feature = allFeatures.find(f => {
            const coords = f.geometry.coordinates;
            // åº§æ¨™ã®èª¤å·®ãŒéå¸¸ã«å°ã•ã„ã‚‚ã®ã‚’ç‰¹å®š
            return Math.abs(coords[0] - lng) < 0.0001 && 
                   Math.abs(coords[1] - lat) < 0.0001;
        });
    }

    // 3. æ¤œç´¢ã«å¤±æ•—ã—ãŸå ´åˆã®ã‚¬ãƒ¼ãƒ‰ï¼ˆã“ã“ã§ã® return ã¯é–¢æ•°å†…ãªã®ã§OKï¼‰
    if (!feature) {
        alert("åœ°ç‚¹ã‚’ç‰¹å®šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
        return; 
    }

    // 4. å®Ÿéš›ã®ç·¨é›†å‡¦ç†
    const oldName = feature.properties.name || "";
    const newName = prompt("æ–°ã—ã„åå‰ã‚’å…¥åŠ›:", oldName);
    
    if (newName !== null && newName !== "") {
        // Drawå´ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
        draw.setFeatureProperty(feature.id, 'name', newName);
        
        // çœ‹æ¿ï¼ˆãƒ©ãƒ™ãƒ«ï¼‰ã‚’æ›´æ–°
        if (typeof refreshLabels === 'function') {
            refreshLabels();
        }
        
        // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å†…ã®è¡¨ç¤ºã‚‚å³åº§ã«æ›¸ãæ›ãˆ
        const nameEl = document.getElementById('popup-name');
        if (nameEl) nameEl.innerText = newName;
        
        document.getElementById('status').innerText = "åå‰ã‚’æ›´æ–°ã—ã¾ã—ãŸ";
    }
};
// --- åå‰ç·¨é›†é–¢æ•° (ã“ã“ã¾ã§) ---

    document.getElementById('btn-del').onclick = () => {
        const ids = draw.getSelectedIds();
        if (ids.length && confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            draw.delete(ids);
            refreshLabels();
        }
    };

    document.getElementById('btn-save').onclick = async () => {
        const btn = document.getElementById('btn-save');
        btn.innerText = "ä¿å­˜ä¸­...";
        const data = draw.getAll();
        data.last_updated = Date.now();
        const content = JSON.stringify(data);

        try {
            const res = await fetch(`https://api.github.com/repos/${REPO_PATH}/contents/${FILE_PATH}`, { headers: { 'Authorization': `token ${GITHUB_TOKEN}` } });
            const info = await res.json();
            const put = await fetch(`https://api.github.com/repos/${REPO_PATH}/contents/${FILE_PATH}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${GITHUB_TOKEN}` },
                body: JSON.stringify({ message: "update", content: btoa(unescape(encodeURIComponent(content))), sha: info.sha })
            });
            if (put.ok) {
                localStorage.setItem('map_backup', content);
                alert("ä¿å­˜å®Œäº†ã—ã¾ã—ãŸï¼");
            }
        } catch (e) { alert("ä¿å­˜å¤±æ•—: " + e.message); }
        btn.innerText = "â˜ï¸ GitHubä¿å­˜";
    };

    // åœ°å›³åˆ‡ã‚Šæ›¿ãˆ
    const switchLayer = (t) => {
        const urls = { 'std': 'std/{z}/{x}/{y}.png', 'pale': 'pale/{z}/{x}/{y}.png', 'ort': 'ort/{z}/{x}/{y}.jpg' };
        map.setLayoutProperty('gsi-layer', 'visibility', 'none');
        map.removeLayer('gsi-layer');
        map.removeSource('gsi');
        map.addSource('gsi', { type: 'raster', tiles: [`https://cyberjapandata.gsi.go.jp/xyz/${urls[t]}`], tileSize: 256, attribution: "åœ°ç†é™¢åœ°å›³" });
        map.addLayer({ id: 'gsi-layer', type: 'raster', source: 'gsi' }, 'labels-layer'); // ãƒ©ãƒ™ãƒ«ã®ä¸‹ã«å…¥ã‚Œã‚‹
    };
    document.getElementById('btn-std').onclick = () => switchLayer('std');
    document.getElementById('btn-pale').onclick = () => switchLayer('pale');
    document.getElementById('btn-ort').onclick = () => switchLayer('ort');
</script>
</body>
</html>
