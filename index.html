<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <title>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆåŒæœŸåœ°å›³</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.css" />
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #ui { position: absolute; top: 10px; left: 10px; z-index: 10; display: flex; flex-direction: column; gap: 8px; width: 220px; }
        .group { background: rgba(255,255,255,0.95); padding: 10px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; flex-direction: column; gap: 8px; }
        button { padding: 10px; cursor: pointer; border: 1px solid #ddd; border-radius: 5px; font-weight: bold; background: white; transition: 0.2s; }
        button:hover { background: #f0f0f0; }
        .layer-btns { display: flex; gap: 4px; }
        .layer-btns button { flex: 1; padding: 5px; font-size: 10px; }
        #status { font-size: 11px; color: #666; text-align: center; }
        select { padding: 5px; border-radius: 4px; border: 1px solid #ccc; font-size: 13px; }
    </style>
</head>
<body>

<div id="ui">
    <div class="group">
        <div style="font-size: 10px; color: #666; margin-bottom: 2px;">åœ°å›³ã®ç¨®é¡</div>
        <select id="layer-select" style="width: 100%;"></select>
    </div>

    <div class="group">
        <button id="btn-add" style="background:#007bff; color:white; border:none;">ğŸ“ åœ°ç‚¹è¿½åŠ : OFF</button>
        <button id="btn-del" style="background:#dc3545; color:white; border:none;">ğŸ—‘ï¸ é¸æŠå‰Šé™¤</button>
        <button id="btn-save" style="background:#28a745; color:white; border:none;">â˜ï¸ ã‚·ãƒ¼ãƒˆã¸ä¿å­˜</button>
        <div id="status">èª­è¾¼ä¸­...</div>
    </div>

    <div class="group">
        <div style="font-size: 10px; color: #666; margin-bottom: 2px;">ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆç®¡ç†</div>
        <select id="sheet-select"></select>
        <div class="layer-btns">
            <button onclick="addDataset()" style="font-size: 10px;">â•æ–°è¦</button>
            <button onclick="renameDataset()" style="font-size: 10px;">âœï¸åå¤‰</button>
        </div>
    </div>
</div>
<div id="map"></div>

<script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzO7vXb4XxOXv3BZo6QsTK_J3ZF8uCIeKR20tpLmDFOwrH7GlIskITbE54XjpzXFAlm/exec';

    // --- 1. å®šæ•°ã¨çŠ¶æ…‹ ---
    const layers = {
        'std': { name: 'æ¨™æº–åœ°å›³', url: 'std/{z}/{x}/{y}.png' },
        'pale': { name: 'æ·¡è‰²åœ°å›³', url: 'pale/{z}/{x}/{y}.png' },
        'blank': { name: 'ç™½åœ°å›³', url: 'blank/{z}/{x}/{y}.png' },
        'english': { name: 'English', url: 'english/{z}/{x}/{y}.png' },
        'ort': { name: 'å†™çœŸ', url: 'ort/{z}/{x}/{y}.jpg' },
        'relief': { name: 'è‰²åˆ¥æ¨™é«˜å›³', url: 'relief/{z}/{x}/{y}.png' }
    };

    const lastState = JSON.parse(localStorage.getItem('map-state')) || {
        center: [139.767, 35.681],
        zoom: 12,
        sheet: 'Sheet1',
        layer: 'std'
    };
    
    let currentSheet = lastState.sheet;
    let currentLayer = lastState.layer;

    // --- 2. åœ°å›³ã®æœ€å°æ§‹æˆã§ã®åˆæœŸåŒ– ---
    const map = new maplibregl.Map({
        container: 'map',
        style: {
            version: 8,
            glyphs: "https://fonts.openmaptiles.org/{fontstack}/{range}.pbf",
            sources: { 
                'labels-src': { type: 'geojson', data: { type: 'FeatureCollection', features: [] } }
            },
            layers: [] // å¾Œã§ switchLayer() ã§è¿½åŠ ã™ã‚‹
        },
        center: lastState.center,
        zoom: lastState.zoom
    });

    const draw = new MapboxDraw({
        displayControlsDefault: false,
        styles: [
            { 'id': 'gl-draw-point-static-cold', 'type': 'circle', 'filter': ['all', ['==', '$type', 'Point'], ['==', 'meta', 'feature'], ['==', 'active', 'false']], 'paint': { 'circle-radius': 12, 'circle-color': 'rgba(0,0,0,0)' } },
            { 'id': 'gl-draw-point-static-hot', 'type': 'circle', 'filter': ['all', ['==', '$type', 'Point'], ['==', 'meta', 'feature'], ['==', 'active', 'true']], 'paint': { 'circle-radius': 12, 'circle-color': '#ffff00', 'circle-stroke-width': 2, 'circle-stroke-color': '#000' } }
        ]
    });
    map.addControl(draw);

    // --- 3. UIé€£æºé–¢æ•° ---
    const saveMapState = () => {
        const state = { center: map.getCenter().toArray(), zoom: map.getZoom(), sheet: currentSheet, layer: currentLayer };
        localStorage.setItem('map-state', JSON.stringify(state));
    };

    const switchLayer = (t) => {
        currentLayer = t;
        const layerInfo = layers[t] || layers['std'];
        const url = `https://cyberjapandata.gsi.go.jp/xyz/${layerInfo.url}`;
        
        if (map.getLayer('gsi-layer')) map.removeLayer('gsi-layer');
        if (map.getSource('gsi')) map.removeSource('gsi');
        
        map.addSource('gsi', { type: 'raster', tiles: [url], tileSize: 256, attribution: "åœ°ç†é™¢åœ°å›³" });
        
        // ãƒ”ãƒ³ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚ˆã‚Šä¸‹ã«é…ç½®ã€‚ãªã‘ã‚Œã°æœ«å°¾ã«è¿½åŠ ã€‚
        const beforeId = map.getLayer('points-layer') ? 'points-layer' : undefined;
        map.addLayer({ id: 'gsi-layer', type: 'raster', source: 'gsi' }, beforeId);
        saveMapState();
    };

    // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ç”Ÿæˆ
    const layerSelect = document.getElementById('layer-select');
    for (const key in layers) {
        const opt = document.createElement('option');
        opt.value = key; opt.text = layers[key].name;
        if (key === currentLayer) opt.selected = true;
        layerSelect.appendChild(opt);
    }
    layerSelect.onchange = (e) => switchLayer(e.target.value);

    // --- 4. åœ°å›³èª­ã¿è¾¼ã¿å¾Œã®å‡¦ç† ---
    map.on('load', async () => {
        // èƒŒæ™¯ã®ã‚»ãƒƒãƒˆ
        switchLayer(currentLayer);

        // ãƒ”ãƒ³ã¨ãƒ©ãƒ™ãƒ«ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ 
        map.addLayer({
            id: 'points-layer',
            type: 'circle',
            source: 'labels-src',
            paint: { 'circle-radius': 8, 'circle-color': ['coalesce', ['get', 'color'], '#ff4500'], 'circle-stroke-width': 2, 'circle-stroke-color': '#fff' }
        });
        map.addLayer({
            id: 'labels-layer',
            type: 'symbol',
            source: 'labels-src',
            layout: { 'text-field': '{name}', 'text-font': ['Open Sans Regular'], 'text-size': 14, 'text-offset': [0, 1.0], 'text-anchor': 'top', 'text-allow-overlap': true },
            paint: { 'text-color': '#000', 'text-halo-color': '#fff', 'text-halo-width': 2 }
        });

        map.on('moveend', saveMapState);
        map.on('zoomend', saveMapState);
        await updateSheetList();
        loadData();
    });

    // --- 5. ãƒ‡ãƒ¼ã‚¿åŒæœŸé–¢é€£ ---
    const updateSheetList = async () => {
        try {
            const res = await fetch(`${GAS_URL}?action=getSheets`);
            const sheets = await res.json();
            const select = document.getElementById('sheet-select');
            select.innerHTML = '';
            sheets.forEach(s => {
                const opt = document.createElement('option');
                opt.value = opt.text = s;
                if (s === currentSheet) opt.selected = true;
                select.appendChild(opt);
            });
        } catch (e) { console.error("ã‚·ãƒ¼ãƒˆä¸€è¦§å–å¾—å¤±æ•—", e); }
    };

    document.getElementById('sheet-select').onchange = (e) => {
        currentSheet = e.target.value;
        saveMapState();
        loadData();
    };

    const loadData = async () => {
        const log = document.getElementById('status');
        log.innerText = "èª­è¾¼ä¸­...";
        try {
            const res = await fetch(`${GAS_URL}?sheet=${encodeURIComponent(currentSheet)}`);
            const data = await res.json(); 
            draw.deleteAll();
            if (data && data.features) {
                data.features.forEach(f => {
                    const c = f.properties.color;
                    if (c) { f.properties.user_color = c; f.properties.color = c; }
                    draw.add(f); 
                });
            }
            refreshLabels();
            log.innerText = `${currentSheet} åŒæœŸå®Œäº†`;
        } catch (e) { log.innerText = "ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—"; }
    };

    const refreshLabels = () => {
        const data = draw.getAll();
        data.features.forEach(f => {
            f.properties.id = f.id;
            const n = String(f.properties.name);
            if (n.includes('T') && n.includes('Z')) f.properties.name = "åç§°æœªè¨­å®š";
        });
        map.getSource('labels-src').setData(data);
    };

    // --- 6. ã‚¤ãƒ™ãƒ³ãƒˆ/ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ---
    let addMode = false;
    document.getElementById('btn-add').onclick = () => {
        addMode = !addMode;
        document.getElementById('btn-add').innerText = addMode ? "ğŸ“ åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯" : "ğŸ“ åœ°ç‚¹è¿½åŠ : OFF";
        document.getElementById('btn-add').style.background = addMode ? "#ff4500" : "#007bff";
    };

    map.on('click', async (e) => {
        if (addMode) {
            const name = prompt("å ´æ‰€ã®åå‰:");
            if (!name) return;
            draw.add({ type: 'Feature', properties: { name: name, color: '#ff4500' }, geometry: { type: 'Point', coordinates: [e.lngLat.lng, e.lngLat.lat] } });
            refreshLabels();
        } else {
            const fs = map.queryRenderedFeatures(e.point, { layers: ['points-layer'] });
            if (fs.length) {
                const target = fs[0];
                const featureId = target.properties.id;
                const currentFeature = draw.get(featureId);
                if (currentFeature) {
                    const [lng, lat] = currentFeature.geometry.coordinates;
                    const name = currentFeature.properties.name || "åç§°æœªè¨­å®š";
                    const color = currentFeature.properties.color || "#ff4500";
                    const popup = new maplibregl.Popup({ closeOnClick: true, offset: 12 }).setLngLat([lng, lat]).setHTML(`
                        <div style="padding:10px; min-width:200px; font-size:13px; line-height:1.5;">
                            <b>${name}</b>
                            <div id="addr-text" style="color:#666; font-size:11px; margin-bottom:8px;">ä½æ‰€ã‚’å–å¾—ä¸­...</div>
                            <hr style="border:0; border-top:1px dashed #ccc; margin:8px 0;">
                            <a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank" 
                               style="display:block; text-align:center; background:#4285f4; color:white; text-decoration:none; padding:8px; border-radius:4px; font-weight:bold; margin-bottom:10px;">
                                ğŸŒ Googleãƒãƒƒãƒ—
                            </a>
                            <div style="display:flex; flex-direction:column; gap:5px;">
                                <button onclick="window.editName('${featureId}')" style="cursor:pointer; padding:5px;">âœï¸ åå‰å¤‰æ›´</button>
                                <input type="color" onchange="window.editColor('${featureId}', this.value)" value="${color}" style="width:100%; height:25px;">
                            </div>
                        </div>
                    `).addTo(map);
                    try {
                        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`, { headers: { 'Accept-Language': 'ja' } });
                        const data = await res.json();
                        const a = data.address;
                        document.getElementById('addr-text').innerText = `${a.province || ''}${a.city || a.town || a.village || ''}${a.suburb || ''}${a.neighbourhood || ''}${a.house_number || ''}`;
                    } catch (err) { document.getElementById('addr-text').innerText = "ä½æ‰€å–å¾—å¤±æ•—"; }
                }
            }
        }
    });

    window.editName = (id) => {
        let target = draw.get(id);
        if (!target) return;
        const newName = prompt("åå‰:", target.properties.name);
        if (newName) { draw.setFeatureProperty(id, 'name', newName); refreshLabels(); }
    };

    window.editColor = (id, newColor) => {
        draw.setFeatureProperty(id, 'color', newColor);
        draw.setFeatureProperty(id, 'user_color', newColor);
        refreshLabels();
    };

    document.getElementById('btn-del').onclick = () => {
        const ids = draw.getSelectedIds();
        if (ids.length && confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { draw.delete(ids); refreshLabels(); }
    };

    document.getElementById('btn-save').onclick = async () => {
        const btn = document.getElementById('btn-save');
        btn.innerText = "ä¿å­˜ä¸­...";
        try {
            await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ sheet: currentSheet, features: draw.getAll().features }) });
            alert("ä¿å­˜å®Œäº†ï¼");
        } catch (e) { alert("ä¿å­˜å¤±æ•—"); }
        btn.innerText = "â˜ï¸ ã‚·ãƒ¼ãƒˆã¸ä¿å­˜";
    };

    const addDataset = async () => { /* æ—¢å­˜ã®ã¾ã¾ */ };
    const renameDataset = async () => { /* æ—¢å­˜ã®ã¾ã¾ */ };
</script>
</body>
</html>
