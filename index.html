<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <title>åå‰è¡¨ç¤ºç·¨é›†GIS</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.css" />
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #ui-panel { position: absolute; top: 10px; left: 10px; z-index: 100; display: flex; flex-direction: column; gap: 10px; }
        button { padding: 10px; cursor: pointer; background: white; border: 2px solid #333; border-radius: 4px; font-weight: bold; }
        #console-log { background: rgba(255, 255, 255, 0.9); padding: 10px; border: 1px solid #ccc; max-width: 250px; font-size: 12px; pointer-events: none; }
    </style>
</head>
<body>
<div id="ui-panel">
    <button id="btn-add-point">ğŸ“ åœ°ç‚¹è¿½åŠ : OFF</button>
    
    <button id="btn-layer-std">ğŸ—ºï¸ æ¨™æº–</button>
    <button id="btn-layer-pale">âšª æ·¡è‰²</button>
    <button id="btn-layer-ort">ğŸ›°ï¸ å†™çœŸ</button>

    <button id="btn-save" style="background: #28a745; color: white; border: none;">â˜ï¸ GitHubã¸ä¿å­˜</button>
    <button id="btn-delete" style="background: #dc3545; color: white; border: none;">ğŸ—‘ï¸ é¸æŠã—ãŸåœ°ç‚¹ã‚’å‰Šé™¤</button>
    <div id="console-log">åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ“ä½œ</div>
</div>
    <div id="map"></div>

    <script>
        // 1. åœ°å›³åˆæœŸåŒ–
const map = new maplibregl.Map({
    container: 'map',
    style: {
        version: 8,
        // ãƒ•ã‚©ãƒ³ãƒˆã®æä¾›å…ƒã‚’ã“ã‚Œã«å¤‰ãˆã¦ã¿ã¦ãã ã•ã„
        glyphs: "https://fonts.openmaptiles.org/{fontstack}/{range}.pbf",
        sources: {
            'gsi-tiles': {
                type: 'raster',
                tiles: ['https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png'],
                tileSize: 256,
                attribution: "åœ°ç†é™¢åœ°å›³"
            }
        },
        layers: [{ id: 'gsi-layer', type: 'raster', source: 'gsi-tiles' }]
    },
    center: [139.767, 35.681],
    zoom: 12
});
// åœ°å›³èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
       map.on('load', async () => {
    // 1. ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’èª­ã¿è¾¼ã‚€
    const localDataRaw = localStorage.getItem('map_data_backup');
    let localData = localDataRaw ? JSON.parse(localDataRaw) : null;

    if (localData) {
        draw.add(localData);
        console.log("ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ");
    }

    try {
        const url = `https://raw.githubusercontent.com/${REPO_PATH}/main/${FILE_PATH}?t=${new Date().getTime()}`;
        const res = await fetch(url, { cache: 'no-store' });

        if (res.ok) {
            const githubData = await res.json();
            
            // â˜…ã€ã“ã“ãŒé‡è¦ã€‘GitHubã®ãƒ‡ãƒ¼ã‚¿ãŒãƒ­ãƒ¼ã‚«ãƒ«ã‚ˆã‚Šæ–°ã—ã„å ´åˆã ã‘æ›´æ–°ã™ã‚‹
            const localTime = localData?.last_updated || 0;
            const githubTime = githubData.last_updated || 0;

            if (githubTime >= localTime) {
                draw.deleteAll();
                draw.add(githubData);
                localStorage.setItem('map_data_backup', JSON.stringify(githubData));
                console.log("GitHubã®æ–¹ãŒæ–°ã—ã„ã®ã§åŒæœŸã—ã¾ã—ãŸ");
            } else {
                console.log("GitHubãŒã¾ã å¤ã„ï¼ˆåæ˜ å¾…ã¡ï¼‰ã®ã§ã€ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å„ªå…ˆã—ã¾ã™");
            }
        }
    } catch (err) {
        console.error("åŒæœŸã‚¨ãƒ©ãƒ¼:", err);
    }
});
        // 2. æç”»ãƒ„ãƒ¼ãƒ«åˆæœŸåŒ–
const draw = new MapboxDraw({
    displayControlsDefault: false,
    styles: [
        // 1. ç‚¹ã®è¦‹ãŸç›®ï¼ˆé€šå¸¸æ™‚ï¼‰
        {
            'id': 'points-static',
            'type': 'circle',
            'filter': ['all', ['==', '$type', 'Point'], ['==', 'meta', 'feature'], ['==', 'active', 'false']],
            'paint': { 'circle-radius': 10, 'circle-color': '#ff4500' }
        },
        // 2. ç‚¹ã®è¦‹ãŸç›®ï¼ˆé¸æŠæ™‚ï¼‰
        {
            'id': 'points-active',
            'type': 'circle',
            'filter': ['all', ['==', '$type', 'Point'], ['==', 'meta', 'feature'], ['==', 'active', 'true']],
            'paint': { 'circle-radius': 12, 'circle-color': '#ffff00', 'circle-stroke-width': 2, 'circle-stroke-color': '#000' }
        },
        // 3. ã€æ–°è¨­ã€‘åå‰ã‚’è¡¨ç¤ºã™ã‚‹ãƒ¬ã‚¤ãƒ¤ãƒ¼
// drawã®stylesé…åˆ—ã®ä¸­ã®ã€Œpoints-labelsã€ã®éƒ¨åˆ†ã ã‘æ›¸ãæ›ãˆã¦ãã ã•ã„
{
    'id': 'points-labels',
    'type': 'symbol',
    'filter': ['all', ['==', '$type', 'Point'], ['==', 'meta', 'feature']],
    'layout': {
        'text-field': ['coalesce', ['get', 'name'], 'åç§°æœªè¨­å®š'], // åå‰ãŒãªã‘ã‚Œã°ã€Œåç§°æœªè¨­å®šã€ã¨å‡ºã™
        'text-font': ['Open Sans Regular', 'Arial Unicode MS Regular'], // ãƒ•ã‚©ãƒ³ãƒˆã‚’æ˜ç¤º
        'text-size': 14,
        'text-anchor': 'top',
        'text-offset': [0, 1.2]
    },
    'paint': {
        'text-color': '#000000',
        'text-halo-color': '#ffffff',
        'text-halo-width': 2
    }
},
        // 4. ç§»å‹•ãƒ»ãƒ‰ãƒ©ãƒƒã‚°ç”¨ã®è¨­å®šï¼ˆèµ¤ç‚¹ï¼‰
        {
            'id': 'points-drag',
            'type': 'circle',
            'filter': ['all', ['==', '$type', 'Point'], ['==', 'meta', 'vertex']], 
            'paint': { 'circle-radius': 12, 'circle-color': '#f00' }
        }
    ]
});
        map.addControl(draw);

        let isAddMode = false;
        const addBtn = document.getElementById('btn-add-point');
        const logDiv = document.getElementById('console-log');

        addBtn.onclick = () => {
            isAddMode = !isAddMode;
            addBtn.style.background = isAddMode ? '#ff4500' : '#fff';
            addBtn.style.color = isAddMode ? '#fff' : '#000';
            addBtn.innerText = isAddMode ? 'ğŸ“ åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é…ç½®' : 'ğŸ“ åœ°ç‚¹è¿½åŠ : OFF';
        };

        // 3. ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆè¿½åŠ ã¨è¡¨ç¤ºã‚’ä¸€ã¤ã®é–¢æ•°ã§ç®¡ç†ï¼‰
        map.on('click', (e) => {
            if (isAddMode) {
                // --- è¿½åŠ ãƒ¢ãƒ¼ãƒ‰æ™‚ã®å‡¦ç† ---
                const locationName = prompt("å ´æ‰€ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", "æ–°è¦åœ°ç‚¹");
                if (locationName === null) return;

                const coords = [e.lngLat.lng, e.lngLat.lat];
                draw.add({
                    type: 'Feature',
                    properties: { name: locationName, time: new Date().toLocaleTimeString() },
                    geometry: { type: 'Point', coordinates: coords }
                });
                logDiv.innerText = `ã€Œ${locationName}ã€ã‚’è¿½åŠ `;
                console.log("æœ€æ–°GeoJSON:", JSON.stringify(draw.getAll()));
            } else {
                // --- ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã®å‡¦ç†ï¼ˆå¼·åŒ–ç‰ˆï¼‰ ---
                
                // ç¾åœ¨åœ°å›³ã«æç”»ã•ã‚Œã¦ã„ã‚‹å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const allData = draw.getAll();
                
                // ã‚¯ãƒªãƒƒã‚¯ã—ãŸåœ°ç‚¹ã®åº§æ¨™ï¼ˆe.lngLatï¼‰ã«è¿‘ã„åœ°ç‚¹ã‚’æ¢ã™
                const clickedPoint = [e.lngLat.lng, e.lngLat.lat];
                
                // ã‚‚ã£ã¨ã‚‚è¿‘ã„ãƒ•ã‚£ãƒ¼ãƒãƒ£ã‚’æ¢ã™ï¼ˆç°¡æ˜“çš„ãªè·é›¢åˆ¤å®šï¼‰
                const clickedFeature = allData.features.find(f => {
                    if (f.geometry.type !== 'Point') return false;
                    const coords = f.geometry.coordinates;
                    // ç·¯åº¦çµŒåº¦ã®å·®ãŒã”ãã‚ãšã‹ï¼ˆç´„100mä»¥å†…ï¼‰ãªã‚‰ã€Œã‚¯ãƒªãƒƒã‚¯ã—ãŸã€ã¨ã¿ãªã™
                    return Math.abs(coords[0] - clickedPoint[0]) < 0.001 && 
                           Math.abs(coords[1] - clickedPoint[1]) < 0.001;
                });

                if (clickedFeature) {
                    const name = clickedFeature.properties.name || "åç§°æœªè¨­å®š";
                    const time = clickedFeature.properties.time || "ä¸æ˜";

                    new maplibregl.Popup()
                        .setLngLat(clickedFeature.geometry.coordinates)
                        .setHTML(`
                            <div style="font-family:sans-serif; padding:5px;">
                                <strong style="color:#ff4500; font-size:1.1em;">${name}</strong><br>
                                <hr style="margin:5px 0; border:0; border-top:1px solid #eee;">
                                <small>ç™»éŒ²æ™‚åˆ»: ${time}</small>
                            </div>
                        `)
                        .addTo(map);
                }
            }
            
        });
        const GITHUB_TOKEN = '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';

        const REPO_PATH = 'tmiyanari/my-gsi-map'; 
        const FILE_PATH = 'mydata.geojson';
document.getElementById('btn-delete').onclick = () => {
    // 1. ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ï¼ˆé»„è‰²ããªã£ã¦ã„ã‚‹ï¼‰åœ°ç‚¹ã‚’å–å¾—
    const selectedFeatures = draw.getSelected();

    if (selectedFeatures.features.length > 0) {
        if (confirm(`${selectedFeatures.features.length} ä»¶ã®åœ°ç‚¹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
            // 2. åœ°å›³ä¸Šã‹ã‚‰å‰Šé™¤
            draw.delete(selectedFeatures.features.map(f => f.id));
            
            // 3. å‰Šé™¤å¾Œã®çŠ¶æ…‹ã§GitHubã«ä¿å­˜
            // â€»å…ˆã»ã©ä½œã£ãŸã€Œä¿å­˜ãƒœã‚¿ãƒ³ã€ã®å‡¦ç†ã‚’è‡ªå‹•ã§å‘¼ã³å‡ºã™ã¨æ¥½ã§ã™
            alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚å¤‰æ›´ã‚’ç¢ºå®šã•ã›ã‚‹ãŸã‚ã«ã€GitHubã¸ä¿å­˜ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
        }
    } else {
        alert("å‰Šé™¤ã—ãŸã„åœ°ç‚¹ã‚’ã¾ãšã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠï¼ˆé»„è‰²ã«ï¼‰ã—ã¦ãã ã•ã„ã€‚");
    }
};
        document.getElementById('btn-save').onclick = async () => {
            const btn = document.getElementById('btn-save');
            const originalText = btn.innerText;
            btn.innerText = "ä¿å­˜ä¸­...";
            btn.disabled = true; // äºŒé‡æŠ¼ã—é˜²æ­¢
            // draw.getAll() ã§å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã«ã€ä»Šã®æ™‚é–“ã‚’åˆ»å°ã™ã‚‹
const rawData = draw.getAll();
rawData.last_updated = new Date().getTime(); // â˜…ã“ã‚Œã‚’è¿½åŠ 
const content = JSON.stringify(rawData, null, 2);
            
            const message = "åœ°å›³ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°: " + new Date().toLocaleString();

            try {
                // 1. ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®æƒ…å ±ã‚’å–å¾—ï¼ˆSHAå–å¾—ï¼‰
                const res = await fetch(`https://api.github.com/repos/${REPO_PATH}/contents/${FILE_PATH}`, {
                    headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
                });
                
                if (!res.ok) throw new Error("ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…ˆã«GitHubä¸Šã« mydata.geojson ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚");
                
                const fileData = await res.json();

                // 2. ä¸Šæ›¸ãã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                const updateRes = await fetch(`https://api.github.com/repos/${REPO_PATH}/contents/${FILE_PATH}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        content: btoa(unescape(encodeURIComponent(content))), 
                        sha: fileData.sha 
                    })
                });

              if (updateRes.ok) {
        alert("ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ã®ä¿å­˜ã«æˆåŠŸã—ã¾ã—ãŸï¼");
        // ä»Šã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«ã‚‚è¦šãˆã•ã›ã‚‹
        localStorage.setItem('map_data_backup', content); 
        btn.innerText = "â˜ï¸ GitHubã¸ä¿å­˜";
    } else {
                    const errorInfo = await updateRes.json();
                    console.error(errorInfo);
                    throw new Error("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                }
            } catch (err) {
                alert(err.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        
};
        // ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆèƒŒæ™¯åœ°å›³ï¼‰ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
const switchLayer = (layerType) => {
    const tiles = {
        'std': 'https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png',
        'pale': 'https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png',
        'ort': 'https://cyberjapandata.gsi.go.jp/xyz/ort/{z}/{x}/{y}.jpg'
    };

    if (map.getSource('gsi-tiles')) {
        map.removeLayer('gsi-layer');
        map.removeSource('gsi-tiles');
    }

    map.addSource('gsi-tiles', {
        type: 'raster',
        tiles: [tiles[layerType]],
        tileSize: 256,
        attribution: "åœ°ç†é™¢åœ°å›³"
    });

    // èƒŒæ™¯ã¨ã—ã¦è¿½åŠ 
    map.addLayer({
        id: 'gsi-layer',
        type: 'raster',
        source: 'gsi-tiles'
    }, map.getStyle().layers[0].id); // ä¸€ç•ªä¸‹ã«è¿½åŠ 

    // â˜…é‡è¦ï¼šèƒŒæ™¯ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã¨æç”»ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒéš ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ãŸã‚ã€drawã‚’å‰é¢ã«
    const drawData = draw.getAll();
    draw.deleteAll();
    draw.add(drawData);
};

// ãƒœã‚¿ãƒ³ã«æ©Ÿèƒ½ã‚’å‰²ã‚Šå½“ã¦
document.getElementById('btn-layer-std').onclick = () => switchLayer('std');
document.getElementById('btn-layer-pale').onclick = () => switchLayer('pale');
document.getElementById('btn-layer-ort').onclick = () => switchLayer('ort');
    </script>
</body>
</html>
