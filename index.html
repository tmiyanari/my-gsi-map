<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <title>ãƒã‚¤ãƒãƒƒãƒ— - æœ€çµ‚å®‰å®šç‰ˆ</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.css" />
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #ui { position: absolute; top: 10px; left: 10px; z-index: 10; display: flex; flex-direction: column; gap: 5px; width: 180px; }
        button { padding: 8px; cursor: pointer; font-weight: bold; background: white; border: 1px solid #ccc; border-radius: 4px; }
        #status { background: rgba(255,255,255,0.8); padding: 5px; font-size: 11px; border-radius: 4px; }
    </style>
</head>
<body>

<div id="ui">
    <button id="btn-add" style="background:#007bff; color:white;">ğŸ“ åœ°ç‚¹è¿½åŠ : OFF</button>
    <button id="btn-save" style="background:#28a745; color:white;">â˜ï¸ ä¿å­˜</button>
    <button id="btn-del" style="background:#dc3545; color:white;">ğŸ—‘ï¸ å‰Šé™¤</button>
    <div id="status">ãƒ­ãƒ¼ãƒ‰ä¸­...</div>
</div>
<div id="map"></div>

<script>
    // --- 1. è¨­å®š (ã“ã“ã¯ã‚ãªãŸã®æƒ…å ±ã«æ›¸ãæ›ãˆã¦ãã ã•ã„) ---
    const GITHUB_TOKEN = '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'; 
    const REPO_PATH = 'tmiyanari/my-gsi-map';
    const FILE_PATH = 'mydata.geojson';

    // --- 2. åœ°å›³åˆæœŸåŒ– ---
    const map = new maplibregl.Map({
        container: 'map',
        style: {
            version: 8,
            glyphs: "https://fonts.openmaptiles.org/{fontstack}/{range}.pbf",
            sources: { 'gsi': { type: 'raster', tiles: ['https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png'], tileSize: 256, attribution: "åœ°ç†é™¢åœ°å›³" } },
            layers: [{ id: 'gsi-layer', type: 'raster', source: 'gsi' }]
        },
        center: [139.767, 35.681],
        zoom: 12
    });

    // --- 3. æç”»ãƒ„ãƒ¼ãƒ«è¨­å®š ---
    const draw = new MapboxDraw({
        displayControlsDefault: false,
        styles: [
            { 'id': 'pts-off', 'type': 'circle', 'filter': ['all', ['==', '$type', 'Point'], ['==', 'active', 'false']], 'paint': { 'circle-radius': 8, 'circle-color': '#ff4500' } },
            { 'id': 'pts-on', 'type': 'circle', 'filter': ['all', ['==', '$type', 'Point'], ['==', 'active', 'true']], 'paint': { 'circle-radius': 10, 'circle-color': '#ffff00' } },
            { 'id': 'lbls', 'type': 'symbol', 'filter': ['all', ['==', '$type', 'Point']], 
              'layout': { 'text-field': '{name}', 'text-font': ['Open Sans Regular'], 'text-size': 14, 'text-offset': [0, 1.2], 'text-anchor': 'top' },
              'paint': { 'text-color': '#000', 'text-halo-color': '#fff', 'text-halo-width': 2 }
            }
        ]
    });
    map.addControl(draw);

    // --- 4. ãƒ‡ãƒ¼ã‚¿å‡¦ç† ---
    const loadData = (data) => {
        if (!data || !data.features) return;
        draw.deleteAll();
        data.features.forEach(f => {
            const id = draw.add(f)[0];
            // æ˜ç¤ºçš„ã«åå‰ã‚’ã‚»ãƒƒãƒˆï¼ˆã“ã‚ŒãŒè¡¨ç¤ºã®éµï¼‰
            draw.setFeatureProperty(id, 'name', f.properties.name || "ç„¡é¡Œ");
        });
    };

    map.on('load', async () => {
        const local = localStorage.getItem('map_backup');
        if (local) { loadData(JSON.parse(local)); document.getElementById('status').innerText = "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾©å…ƒå®Œäº†"; }

        try {
            const res = await fetch(`https://raw.githubusercontent.com/${REPO_PATH}/main/${FILE_PATH}?t=${Date.now()}`);
            if (res.ok) {
                const json = await res.json();
                loadData(json);
                localStorage.setItem('map_backup', JSON.stringify(json));
                document.getElementById('status').innerText = "GitHubåŒæœŸå®Œäº†";
            }
        } catch (e) { document.getElementById('status').innerText = "åŒæœŸå¤±æ•—(ã‚ªãƒ•ãƒ©ã‚¤ãƒ³)"; }
    });

    // --- 5. æ“ä½œ ---
    let mode = false;
    document.getElementById('btn-add').onclick = () => {
        mode = !mode;
        document.getElementById('btn-add').innerText = mode ? "ğŸ“ åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯" : "ğŸ“ åœ°ç‚¹è¿½åŠ : OFF";
        document.getElementById('btn-add').style.background = mode ? "#ff4500" : "#007bff";
    };

    map.on('click', (e) => {
        if (!mode) {
            const f = map.queryRenderedFeatures(e.point).filter(x => x.properties.name)[0];
            if (f) new maplibregl.Popup().setLngLat(e.lngLat).setHTML(`<b>${f.properties.name}</b>`).addTo(map);
            return;
        }
        const n = prompt("åå‰ã‚’å…¥åŠ›:");
        if (!n) return;
        const id = draw.add({ type: 'Feature', properties: { name: n }, geometry: { type: 'Point', coordinates: [e.lngLat.lng, e.lngLat.lat] } })[0];
        draw.setFeatureProperty(id, 'name', n);
    });

    document.getElementById('btn-del').onclick = () => {
        const sel = draw.getSelectedIds();
        if (sel.length) draw.delete(sel);
    };

    document.getElementById('btn-save').onclick = async () => {
        const btn = document.getElementById('btn-save');
        btn.innerText = "ä¿å­˜ä¸­...";
        const content = JSON.stringify(draw.getAll());
        try {
            const res = await fetch(`https://api.github.com/repos/${REPO_PATH}/contents/${FILE_PATH}`, { headers: { 'Authorization': `token ${GITHUB_TOKEN}` } });
            const info = await res.json();
            const put = await fetch(`https://api.github.com/repos/${REPO_PATH}/contents/${FILE_PATH}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${GITHUB_TOKEN}` },
                body: JSON.stringify({ message: "update", content: btoa(unescape(encodeURIComponent(content))), sha: info.sha })
            });
            if (put.ok) { localStorage.setItem('map_backup', content); alert("æˆåŠŸï¼"); }
        } catch (e) { alert("ã‚¨ãƒ©ãƒ¼"); }
        btn.innerText = "â˜ï¸ ä¿å­˜";
    };
</script>
</body>
</html>
